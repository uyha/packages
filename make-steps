#!/usr/bin/env bash

set -euo pipefail

src_dir="${src_dir:-$(mktemp -d)}"
install_dir="${install_dir:-$HOME/.local/opt/$name}"

package-fetch() {
  if ! [[ -d "$src_dir" ]]; then
    mkdir -p "$src_dir"
  fi
  curl -L -o - "$url" | tar --${archive_format:-xz} -xf - -C "$src_dir" --strip-components=1
}

package-change-directory() {
  pushd "$src_dir" 1>/dev/null
}

package-configure() {
  ./configure --prefix="$install_dir"
}

package-build() {
  make -j$(nproc)
}

package-install() {
  rm -rf "$install_dir"

  make install -j$(nproc)
}

package-restore-directory() {
  popd 1>/dev/null
}

package-clean() {
  rm -rf "$src_dir"
}

steps=(
  fetch
  change-directory
  configure
  build
  install
  restore-directory
  clean
)
